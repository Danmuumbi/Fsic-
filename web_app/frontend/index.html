<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Proof Engine | Intelligent Synchronization Technology</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00ff88;
            --primary-dark: #00cc6a;
            --secondary: #6c5ce7;
            --danger: #ff6b6b;
            --warning: #feca57;
            --info: #54a0ff;
            --dark: #0b0f14;
            --dark-card: #1a1f29;
            --dark-border: #2d3746;
            --text: #ffffff;
            --text-muted: #a0aec0;
            --radius: 10px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--dark);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--dark-card) 0%, #151a24 100%);
            padding: 40px 0;
            text-align: center;
            border-bottom: 1px solid var(--dark-border);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 20%, rgba(0, 255, 136, 0.1) 0%, transparent 70%);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            margin-right: 15px;
            color: var(--primary);
        }

        .logo-text {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tagline {
            font-size: 1.2rem;
            color: var(--text-muted);
            max-width: 600px;
            margin: 0 auto 25px;
        }

        /* Cards */
        .card {
            background: var(--dark-card);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--dark-border);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--dark-border);
        }

        .card-icon {
            font-size: 1.5rem;
            margin-right: 12px;
            color: var(--primary);
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: var(--transition);
            margin: 5px;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #4a5568;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #5a4fd8;
        }

        /* Status Messages */
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            border-left: 4px solid;
            background: rgba(255, 255, 255, 0.05);
        }

        .status.success {
            border-color: var(--primary);
            background: rgba(0, 255, 136, 0.1);
        }

        .status.error {
            border-color: var(--danger);
            background: rgba(255, 107, 107, 0.1);
        }

        .status.info {
            border-color: var(--info);
            background: rgba(84, 160, 255, 0.1);
        }

        .status.warning {
            border-color: var(--warning);
            background: rgba(254, 202, 87, 0.1);
        }

        /* Glyphs */
        .glyph {
            border-left: 4px solid;
            padding: 18px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0 8px 8px 0;
            transition: var(--transition);
            cursor: pointer;
        }

        .glyph:hover {
            background: rgba(255, 255, 255, 0.07);
        }

        .glyph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .glyph-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .glyph-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .glyph-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .glyph-detail {
            display: flex;
            align-items: center;
        }

        .glyph-detail i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
            color: var(--primary);
        }

        /* Advantage Banner */
        .advantage {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: black;
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            font-weight: 700;
            margin: 20px 0;
            font-size: 1.3rem;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--dark-border);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            border-color: var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Waveform */
        #waveCanvas {
            width: 100%;
            height: 140px;
            background: #000;
            display: block;
            border-radius: 6px;
            margin-top: 15px;
        }

        /* Chart */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 0;
            margin-top: 40px;
            border-top: 1px solid var(--dark-border);
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 0.9rem;
            }
            
            .glyph-details {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted var(--text-muted);
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark-card);
            color: var(--text);
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid var(--dark-border);
            box-shadow: var(--shadow);
            font-size: 0.85rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Value Proposition */
        .value-prop {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .value-card {
            background: var(--dark-card);
            padding: 25px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--dark-border);
        }

        .value-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .value-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* CTA Section */
        .cta-section {
            text-align: center;
            padding: 40px 0;
            background: linear-gradient(135deg, var(--dark-card) 0%, #151a24 100%);
            border-radius: var(--radius);
            margin: 40px 0;
            border: 1px solid var(--dark-border);
        }

        .cta-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .cta-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            max-width: 600px;
            margin: 0 auto 25px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="logo">
                <div class="logo-icon">⚡</div>
                <div class="logo-text">Flow Proof Engine</div>
            </div>
            <p class="tagline">Demonstrating Intelligent Synchronization Technology with Flow Substrate Intelligence Convergence</p>
            
            <!-- Value Proposition -->
            <div class="value-prop">
                <div class="value-card">
                    <div class="value-icon"><i class="fas fa-bolt"></i></div>
                    <div class="value-title">10-30% Faster</div>
                    <p>Flow synchronization outperforms traditional methods with significant speed advantages</p>
                </div>
                <div class="value-card">
                    <div class="value-icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="value-title">Enhanced Stability</div>
                    <p>Superior resilience to noise and perturbations with faster recovery times</p>
                </div>
                <div class="value-card">
                    <div class="value-icon"><i class="fas fa-brain"></i></div>
                    <div class="value-title">Intelligent Adaptation</div>
                    <p>Self-optimizing parameters for different data types and conditions</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container" style="margin-top: 80px;">
        <!-- Quick Start -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon"><i class="fas fa-rocket"></i></div>
                <div class="card-title">Quick Start</div>
            </div>
            <p>Run a comparison between Flow synchronization and traditional methods, or test the FSIC engine directly.</p>
            
            <div style="margin: 20px 0;">
                <button class="btn" onclick="runDemo()" id="demoBtn">
                    <i class="fas fa-chart-bar"></i> Run FSIC Comparison
                </button>
                <button class="btn btn-secondary" onclick="testFSIC()" id="testBtn">
                    <i class="fas fa-cogs"></i> Test FSIC Engine
                </button>
            </div>
            
            <div id="status" class="status info">
                <i class="fas fa-info-circle"></i> Click "Test FSIC Engine" to verify system connectivity
            </div>
        </div>

        <!-- Results -->
        <div class="card" id="resultsCard" style="display:none">
            <div class="card-header">
                <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                <div class="card-title">Performance Results</div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="overview">Overview</div>
                <div class="tab" data-tab="details">Detailed Analysis</div>
            </div>
            
            <div class="tab-content active" id="overview-tab">
                <div id="results"></div>
                <div class="chart-container">
                    <canvas id="chart"></canvas>
                </div>
            </div>
            
            <div class="tab-content" id="details-tab">
                <div id="detailedResults"></div>
            </div>
        </div>

        <!-- Advanced Demo -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon"><i class="fas fa-music"></i></div>
                <div class="card-title">Advanced Demo – Real Audio Analysis</div>
            </div>
            <p>Upload a music file to see Flow synchronization in action across different frequency bands (LOW, MID, HIGH). The system will identify optimal fusion points as interactive glyphs.</p>
            
            <div style="margin: 20px 0;">
                <input type="file" id="fileInput" accept="audio/*" style="display:none">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i> Upload Audio File
                </button>
                <div class="tooltip" style="margin-left: 10px;">
                    <i class="fas fa-question-circle"></i>
                    <span class="tooltiptext">Supported formats: MP3, WAV, OGG. File size limit: 10MB.</span>
                </div>
            </div>
            
            <div id="fileInfo" class="status info">
                <i class="fas fa-info-circle"></i> No file selected
            </div>

            <audio id="player" controls style="width:100%; margin-top:20px; display:none"></audio>
            <canvas id="waveCanvas"></canvas>
            
            <div style="margin: 15px 0;">
                <label style="margin-right:15px;"><input type="checkbox" id="chkLow" checked> <i class="fas fa-wave-square" style="color:#ff6b6b"></i> Low Band (Bass/Foundation)</label>
                <label style="margin-right:15px;"><input type="checkbox" id="chkMid" checked> <i class="fas fa-wave-square" style="color:#feca57"></i> Mid Band (Performance)</label>
                <label><input type="checkbox" id="chkHigh" checked> <i class="fas fa-wave-square" style="color:#1dd1a1"></i> High Band (Precision)</label>
            </div>
            
            <div id="glyphResult"></div>
        </div>

     
    </div>





    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <p>Flow Proof Engine &copy; 2025 | Intelligent Synchronization Technology</p>
            <p style="margin-top: 10px; font-size: 0.8rem;">Demonstrating Flow Substrate Intelligence Convergence (FSIC)</p>
        </div>
    </div>

    <script>
        // API configuration
        // const API = "https://fsic-9h4f.onrender.com";

        const API = "https://fsic-9h4f.onrender.com";

        let chartInstance = null;
        let playheadReq = null;

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Show corresponding tab content
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        /* ----- Test FSIC Engine ----- */
        async function testFSIC() {
            const status = document.getElementById('status');
            const testBtn = document.getElementById('testBtn');
            status.className = "status info";
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing FSIC engine...';
            testBtn.disabled = true;
            
            try {
                const res = await fetch(`${API}/test-fsic`);
                if (!res.ok) throw new Error(`Server returned ${res.status}`);
                const data = await res.json();
                status.className = "status success";
                status.innerHTML = `<i class="fas fa-check-circle"></i> ${data.status}<br>Fuse time: ${data.fuse_time.toFixed(2)}s, Stability: ${(data.final_R*100).toFixed(1)}%`;
            } catch (err) {
                status.className = "status error";
                status.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Cannot connect to backend<br>${err.message}`;
            } finally {
                testBtn.disabled = false;
            }
        }

        /* ----- Run FSIC comparison (phi vs sin) ----- */
        async function runDemo() {
            const status = document.getElementById('status');
            const demoBtn = document.getElementById('demoBtn');
            status.className = "status info";
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running FSIC comparison...';
            demoBtn.disabled = true;
            
            try {
                const res = await fetch(`${API}/compare`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({demo:true})
                });
                
                if (!res.ok) throw new Error(`Server error ${res.status}`);
                const data = await res.json();
                displayResults(data);
                status.className = "status success";
                status.innerHTML = '<i class="fas fa-check-circle"></i> Analysis complete! Flow advantage demonstrated.';
            } catch (err) {
                status.className = "status error";
                status.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${err.message}<br>Please test the FSIC engine first.`;
            } finally {
                demoBtn.disabled = false;
            }
        }

        /* ----- Display comparison results ----- */
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const detailedResultsDiv = document.getElementById('detailedResults');
            const card = document.getElementById('resultsCard');
            
            // Overview tab content
            resultsDiv.innerHTML = `
                <div class="advantage">
                    ⚡ Flow System is ${data.performance.time_advantage.toFixed(1)}% faster and
                    ${data.performance.stability_advantage.toFixed(1)}% more stable!
                </div>
                <p style="margin: 15px 0;">The Flow synchronization method demonstrates clear performance advantages over traditional approaches, with faster convergence times and superior stability under varying conditions.</p>
            `;
            
            // Detailed tab content
            detailedResultsDiv.innerHTML = '<h3 style="margin-bottom: 15px;">Detailed Performance Metrics</h3>';
            
            data.glyphs.forEach(g => {
                const fuseDisplay = g.fuse_time > 0 ? `${g.fuse_time.toFixed(2)}s` : 'No fusion';
                const statusIcon = g.fused ? '<i class="fas fa-check" style="color:var(--primary)"></i>' : '<i class="fas fa-times" style="color:var(--danger)"></i>';
                const statusText = g.fused ? 'FUSED' : 'No fusion';
                const modeIcon = g.mode === 'phi' ? '<i class="fas fa-bolt" style="color:var(--primary)"></i>' : '<i class="fas fa-wave-sine" style="color:var(--info)"></i>';
                
                const glyphHTML = `
                    <div class="glyph" style="border-color:${g.color}">
                        <div class="glyph-header">
                            <div class="glyph-title">${modeIcon} ${g.name}</div>
                            <div class="glyph-badge" style="background:${g.color}20; color:${g.color}">${g.mode === 'phi' ? 'Flow (φ)' : 'Traditional'}</div>
                        </div>
                        <div class="glyph-details">
                            <div class="glyph-detail"><i class="fas fa-clock"></i> Fusion Time: ${fuseDisplay}</div>
                            <div class="glyph-detail"><i class="fas fa-chart-line"></i> Stability: ${(g.final_R*100).toFixed(1)}%</div>
                            <div class="glyph-detail">${statusIcon} Status: ${statusText}</div>
                        </div>
                    </div>
                `;
                
                resultsDiv.innerHTML += glyphHTML;
                detailedResultsDiv.innerHTML += glyphHTML;
            });
            
            card.style.display = 'block';
            createChart(data.glyphs);
        }

        /* ----- Chart.js ----- */
        function createChart(glyphs) {
            const ctx = document.getElementById('chart').getContext('2d');
            const fused = glyphs.filter(g => g.fused && g.fuse_time > 0);
            if (!fused.length) return;

            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fused.map(g => g.name),
                    datasets: [{
                        label: 'Fusion Time (seconds) – Lower is better',
                        data: fused.map(g => g.fuse_time),
                        backgroundColor: fused.map(g => g.color),
                        borderColor: fused.map(g => g.color),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { 
                                display: true, 
                                text: 'Seconds',
                                color: '#a0aec0'
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#a0aec0' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#a0aec0' }
                        }
                    },
                    plugins: {
                        title: { 
                            display: true, 
                            text: 'Flow vs Traditional Fusion Performance',
                            color: '#ffffff',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#a0aec0' }
                        }
                    }
                }
            });
        }

        /* ----- Audio upload ----- */
        document.getElementById('fileInput').addEventListener('change', async e => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                document.getElementById('fileInfo').className = "status error";
                document.getElementById('fileInfo').innerHTML = '<i class="fas fa-exclamation-triangle"></i> File too large. Please select a file under 10MB.';
                return;
            }
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.className = "status info";
            fileInfo.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Selected: ${file.name} – Uploading...`;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${API}/upload-music`, { method: 'POST', body: formData });
                if (!res.ok) {
                    const txt = await res.text().catch(() => null);
                    throw new Error(`Upload failed: ${res.status} ${txt || ''}`);
                }
                const data = await res.json();

                fileInfo.className = "status success";
                fileInfo.innerHTML = `<i class="fas fa-check-circle"></i> Analysis complete for ${data.audio_info.filename}<br>Duration: ${data.audio_info.duration}s`;

                const player = document.getElementById('player');
                player.src = URL.createObjectURL(file);
                player.style.display = 'block';

                // Draw waveform with shaded segment overlays & update glyph list
                drawWaveform(data.waveform, data.segments, data.audio_info.duration);
                showGlyphs(data.segments, data.audio_info.duration, data.waveform);

                // Initialize playhead listeners
                setupPlayhead(player, data.audio_info.duration);
            } catch (err) {
                fileInfo.className = "status error";
                fileInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Upload failed: ${err.message}`;
                console.error(err);
            }
        });

        /* ----- Draw waveform with shaded band regions + playhead ----- */
        function drawWaveform(wave, segments = [], duration = 0) {
            const canvas = document.getElementById('waveCanvas');
            const ctx = canvas.getContext('2d');
            // Fit canvas to container
            canvas.width = canvas.offsetWidth;
            canvas.height = 140;

            // Background
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!wave || !wave.length) return;

            // Draw shaded band regions first (so waveform is on top)
            if (segments && segments.length && duration > 0) {
                segments.forEach(seg => {
                    const startX = (seg.start_time / duration) * canvas.width;
                    const endX = (seg.end_time / duration) * canvas.width;
                    let color = 'rgba(108, 92, 231, 0.12)'; // mixed/default
                    if (seg.band === 'low') color = 'rgba(255, 107, 107, 0.12)';
                    else if (seg.band === 'mid') color = 'rgba(254, 202, 87, 0.12)';
                    else if (seg.band === 'high') color = 'rgba(29, 209, 161, 0.12)';

                    ctx.fillStyle = color;
                    ctx.fillRect(startX, 0, Math.max(1, endX - startX), canvas.height);

                    // Outline
                    ctx.strokeStyle = (seg.color || '#6c5ce7');
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(startX, 0);
                    ctx.lineTo(startX, canvas.height);
                    ctx.moveTo(endX, 0);
                    ctx.lineTo(endX, canvas.height);
                    ctx.stroke();
                });
            }

            // Waveform line
            ctx.strokeStyle = "#00ff88";
            ctx.beginPath();
            const mid = canvas.height / 2;
            const step = wave.length / canvas.width;
            ctx.lineWidth = 1.2;
            ctx.moveTo(0, mid);
            for (let x = 0; x < canvas.width; x++) {
                const v = wave[Math.floor(x * step)] || 0;
                ctx.lineTo(x, mid + v * mid);
            }
            ctx.stroke();

            // Draw legend
            drawLegend(ctx, canvas);
        }

        /* Small legend */
        function drawLegend(ctx, canvas) {
            const left = 8, top = 6;
            ctx.font = "12px Arial";
            ctx.fillStyle = "rgba(255,255,255,0.85)";
            ctx.fillText("Legend:", left, top + 10);
            const boxes = [
                {label: "LOW", color: "rgba(255,107,107,0.9)", desc: "Bass/Foundation"},
                {label: "MID", color: "rgba(254,202,87,0.9)", desc: "Performance"},
                {label: "HIGH", color: "rgba(29,209,161,0.9)", desc: "Precision"},
                {label: "MIXED", color: "rgba(108,92,231,0.9)", desc: "Combined"}
            ];
            boxes.forEach((b, i) => {
                const x = left + 60 + i * 90;
                ctx.fillStyle = b.color;
                ctx.fillRect(x, top, 12, 12);
                ctx.fillStyle = "#fff";
                ctx.fillText(b.label, x + 16, top + 10);
            });
        }

        /* ----- Playhead animation (updates while audio plays) ----- */
        function setupPlayhead(player, duration) {
            const canvas = document.getElementById('waveCanvas');
            const ctx = canvas.getContext('2d');

            // Cancel existing request
            if (playheadReq) {
                cancelAnimationFrame(playheadReq);
                playheadReq = null;
            }

            function drawPlayhead() {
                // Redraw waveform from stored data
                if (!window.__last_waveform) {
                    playheadReq = requestAnimationFrame(drawPlayhead);
                    return;
                }
                drawWaveform(window.__last_waveform, window.__last_segments || [], duration);

                // Draw playhead
                const t = player.currentTime || 0;
                const x = (t / Math.max(0.001, duration)) * canvas.width;
                ctx.strokeStyle = "rgba(255,255,255,0.9)";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();

                if (!player.paused && !player.ended) {
                    playheadReq = requestAnimationFrame(drawPlayhead);
                }
            }

            // Attach start/stop listeners
            player.removeEventListener('play', player._playHeadStart);
            player.removeEventListener('pause', player._playHeadStop);
            player.removeEventListener('ended', player._playHeadStop);

            player._playHeadStart = () => { playheadReq = requestAnimationFrame(drawPlayhead); };
            player._playHeadStop = () => { if (playheadReq) cancelAnimationFrame(playheadReq); playheadReq = null; };

            player.addEventListener('play', player._playHeadStart);
            player.addEventListener('pause', player._playHeadStop);
            player.addEventListener('ended', player._playHeadStop);
        }

        /* ----- Show segments (glyphs) with click-to-play + band toggles ----- */
        function showGlyphs(segments, duration = 0, waveform = []) {
            // Store globally for playhead redraw
            window.__last_waveform = waveform;
            window.__last_segments = segments;

            const div = document.getElementById('glyphResult');
            div.innerHTML = `
                <h3 style="margin: 20px 0 10px;"><i class="fas fa-shapes"></i> Per-Band FSIC Glyphs</h3>
                <p style="margin-bottom: 15px; color: var(--text-muted);">Click on any glyph to play that audio segment. Toggle bands above to filter visibility.</p>
            `;

            const player = document.getElementById('player');
            let currentPlaying = null;

            // Add event handlers to toggles
            ['chkLow','chkMid','chkHigh'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    // Redraw waveform with only selected segments
                    const sel = segments.filter(s => {
                        if (s.band === 'low' && !document.getElementById('chkLow').checked) return false;
                        if (s.band === 'mid' && !document.getElementById('chkMid').checked) return false;
                        if (s.band === 'high' && !document.getElementById('chkHigh').checked) return false;
                        return true;
                    });
                    drawWaveform(window.__last_waveform || waveform, sel, duration);
                });
            });

            // Build glyph cards (chronological)
            segments.sort((a,b) => a.start_time - b.start_time);
            segments.forEach((g) => {
                const fuseDisplay = isNaN(g.fuse_time) ? 'No fusion' : `${g.fuse_time.toFixed(2)}s`;
                const bandIcon = g.band === 'low' ? '<i class="fas fa-wave-square" style="color:#ff6b6b"></i>' : 
                                g.band === 'mid' ? '<i class="fas fa-wave-square" style="color:#feca57"></i>' : 
                                '<i class="fas fa-wave-square" style="color:#1dd1a1"></i>';
                const bandDesc = g.band === 'low' ? 'Bass/Foundation' : 
                                g.band === 'mid' ? 'Performance' : 'Precision';
                
                const card = document.createElement('div');
                card.className = "glyph";
                card.style.borderColor = g.color || '#6c5ce7';
                card.style.cursor = "pointer";
                card.innerHTML = `
                    <div class="glyph-header">
                        <div class="glyph-title">${bandIcon} ${(g.band || 'UNKNOWN').toUpperCase()} Band • ${bandDesc}</div>
                        <div class="glyph-badge" style="background:${g.color || '#6c5ce7'}20; color:${g.color || '#6c5ce7'}">${g.start_time}s – ${g.end_time}s</div>
                    </div>
                    <div class="glyph-details">
                        <div class="glyph-detail"><i class="fas fa-bolt"></i> Fusion Time: ${fuseDisplay}</div>
                        <div class="glyph-detail"><i class="fas fa-chart-line"></i> Stability: ${g.final_R ? (g.final_R*100).toFixed(1) : 'N/A'}%</div>
                        <div class="glyph-detail"><i class="fas fa-${g.fused ? 'check' : 'times'}"></i> Status: ${g.fused ? 'FUSED' : 'No fusion'}</div>
                    </div>
                    <div style="font-size:11px;color:#aaa;margin-top:10px">
                        Configuration: seed=${g.cfg.seed}, sigma=${g.cfg.sigma_omega.toFixed(3)}, J_tan=${g.cfg.J_tan.toFixed(3)}
                    </div>
                `;

                card.addEventListener('click', () => {
                    // Set audio range play
                    if (g.start_time === undefined || g.end_time === undefined) return;
                    
                    // Highlight
                    if (currentPlaying) currentPlaying.style.backgroundColor = "rgba(255,255,255,0.03)";
                    card.style.backgroundColor = "rgba(0,255,136,0.12)";
                    currentPlaying = card;

                    player.currentTime = g.start_time;
                    player.play();

                    const onTimeUpdate = () => {
                        if (player.currentTime >= g.end_time) {
                            player.pause();
                            player.removeEventListener('timeupdate', onTimeUpdate);
                            card.style.backgroundColor = "rgba(255,255,255,0.03)";
                        }
                    };
                    player.addEventListener('timeupdate', onTimeUpdate);
                });

                div.appendChild(card);
            });
        }

        /* ----- Initial load ----- */
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Flow Proof Engine Frontend Loaded');
        });
    </script>
</body>
</html>